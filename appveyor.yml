version: '{build}'

image: Windows Server 2019

environment:
  DOCKER_USER:
    secure: LJxMxZl1dCKgMF5FlErnwQ==
  DOCKER_PASS:
    secure: HASfuLeqW86zydzpb7/5Zg==
  DOCKER_IMAGE_NAME: eventstore/eventstore

init:
  - ps: docker version
  - ps: docker info
  - ps: docker images
  - ps: |
      cinst curl -y --no-progress
      sal curl (Join-Path $env:ChocolateyInstall "bin\curl.exe") -O AllScope

build_script:
  - ps: |
      # cd $env:APPVEYOR_BUILD_FOLDER
      # cd .\windowsservercore
      # docker build -t $env:DOCKER_IMAGE_NAME .
      docker images

test_script:
  - ps: Switch-DockerLinux
  - ps: |
      $cid = docker run -d -p 2113:2113 -p 1113:1113 $env:DOCKER_IMAGE_NAME
      echo $cid
      $hostip = docker inspect -f "{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}" $cid
      echo $hostip
      Start-Sleep -s 15
      curl "http://${hostip}:2113" -s -f --connect-timeout 30
      Test-NetConnection -Port 1113 -ComputerName ${hostip} -InformationLevel "Detailed"

# deploy_script:
#   - ps: |
#       echo $env:DOCKER_PASS | docker login -u $env:DOCKER_USER --password-stdin
#       docker push $env:DOCKER_IMAGE_NAME